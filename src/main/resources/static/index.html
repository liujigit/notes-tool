<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <title>note tool</title>
    <style>
        html,body {
            width: 98%;
            height: 98%;
            padding: 0;
        }
        #vditor {
            width: 100%;
            height: 100%;
            padding: 0;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/vditor@3.9.8/dist/index.css" />
    <script src="https://unpkg.com/vditor@3.9.8/dist/index.min.js"></script>
</head>
<body>
<div id="vditor"></div>
<script>
    let themeMap = {
        'dark': ['dark', 'dark', 'native'],
        'light': ['classic', 'light', 'github']
    };
    let toolbar = [
        {
            name:'emoji',
            tipPosition: 'se',
        },
        {
            name:'headings',
            tipPosition: 'se',
        },
        {
            name:'bold',
            tipPosition: 'se',
        },
        {
            name:'italic',
            tipPosition: 'se',
        },
        {
            name:'strike',
            tipPosition: 'se',
        },
        {
            name:'link',
            tipPosition: 'se',
        },
        "|",
        {
            name:'list',
            tipPosition: 'se',
        },
        {
            name:'ordered-list',
            tipPosition: 'se',
        },
        {
            name:'check',
            tipPosition: 'se',
        },
        {
            name:'outdent',
            tipPosition: 'se',
        },
        {
            name:'indent',
            tipPosition: 'se',
        },
        "|",
        {
            name:'quote',
            tipPosition: 'se',
        },
        {
            name:'line',
            tipPosition: 'se',
        },
        {
            name:'code',
            tipPosition: 'se',
        },
        {
            name:'inline-code',
            tipPosition: 'se',
        },
        {
            name:'insert-before',
            tipPosition: 'se',
        },
        {
            name:'insert-after',
            tipPosition: 'se',
        },
        "|",
        // {
        //     name:'upload',
        //     tipPosition: 'se',
        // },
        // {
        //     name:'record',
        //     tipPosition: 'se',
        // },
        {
            name:'table',
            tipPosition: 'se',
        },
        "|",
        {
            name:'undo',
            tipPosition: 'se',
        },
        {
            name:'redo',
            tipPosition: 'se',
        },
        // "|",
        // {
        //     name:'fullscreen',
        //     tipPosition: 'se',
        // },
        // {
        //     name:'edit-mode',
        //     tipPosition: 'se',
        // },
        // {
        //     name: "more",
        //     tipPosition: 'sw',
        //     toolbar: [
        //         "both",
        //         "code-theme",
        //         "content-theme",
        //         "export",
        //         "outline",
        //         "preview",
        //         "devtools",
        //         "info",
        //         "help",
        //     ],
        // },
    ];
    function getParam(key,defaultValue) {
        const urlSearchParams = new URLSearchParams(window.location.search);
        const value = urlSearchParams.get(key);
        return value ? value : defaultValue;
    }

    const vditor = new Vditor('vditor', {
        height: '100%',
        width: 'auto',
        mode: 'wysiwyg',  //sv, ir, wysiwyg
        lang: getParam('lang','zh_CN'), // zh_CN,en_US" +
        theme: themeMap[getParam('theme','dark')][0], //dark、classic
        icon: 'ant', // material,ant
        placeholder: '请输入',
        toolbar: toolbar,
        cdn: 'https://unpkg.com/vditor@3.9.8',
        outline: {
            enable: false,
            position: 'left',
        },
        value: null,
        cache: {
            enable: true,
            id: 'note-' + getParam('id','-1'),
        },
        fullscreen: {
            index:100
        },
        debugger: false,
        typewriterMode: true,
        preview: {
            actions: ["desktop", "tablet", "mobile"], //" desktop", "tablet", "mobile", "mp-wechat", "zhihu"
            theme: {
                current: themeMap[getParam('theme','dark')][1],
            },
            hljs:{
                style:themeMap[getParam('theme','dark')][2],
            },
            markdown: {
                toc: false,
                mark: false,
                footnotes: true,
                autoSpace: true,
            },
            math: {
                engine: 'KaTeX',
            },
        },
        toolbarConfig: {
            pin: true, //固定工具栏
        },
        counter: {
            enable: true,
            type: 'markdown',
        },
        tab: '\t',
    });

    function setValue(value){
        console.log("setValue:"+value);
        vditor.setValue(value);
    }


    function setCustomTheme(theme){
        console.log(theme);
        vditor.setTheme(...themeMap[theme])
    }


    function removeNoteCache(id) {
        console.log("removeNoteCache");
        window.noteQuery({
            request: 'removeNoteContent:'+id,
            persistent: true,
            onSuccess: function(response) {
                return response;
            },
            onFailure: function(error_code, error_message) {
                console.log("error_message removeNoteCache:" + error_message);
            }
        })
    }

    function getNoteCache(id) {
        console.log("getNoteCache");
        try {
            window.noteQuery({
                request: 'getNote:'+id,
                persistent: true,
                onSuccess: function(response) {
                   setValue(response)
                },
                onFailure: function(error_code, error_message) {
                    console.log("error_message getNoteCache:" + error_message);
                }
            })
        }catch(err) {
            console.log(err);
        }
    }

    function setNoteCache(id,content) {
        console.log("setNoteCache");
        window.noteQuery({
            request: 'setNote:'+id+"-:"+content,
            persistent: true,
            onSuccess: function(response) {
                console.log(response);
            },
            onFailure: function(error_code, error_message) {
                console.log("error_message setNoteCache:" + error_message);
            }
        })
    }


</script>
</body>
</html>